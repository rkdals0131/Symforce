# PGO 101 - Chapter 2 이론 강의: SLAM 데이터의 표준어, g2o 포맷

**강의 목표:** 이 강의를 마치면, 여러분은 SLAM 커뮤니티에서 표준처럼 사용되는 `g2o` 파일 포맷의 구조를 완벽하게 이해하게 됩니다. `VERTEX` 와 `EDGE` 가 각각 무엇을 의미하는지, 그리고 측정의 신뢰도를 나타내는 `Information Matrix` 가 최적화에 어떤 영향을 미치는지 설명할 수 있게 됩니다. 이 강의는 `chapter02_understanding_g2o_format.ipynb` 실습에서 실제 데이터셋을 파싱하고 분석하기 위한 필수적인 사전 지식을 제공합니다.

---

## 1. 그래프 기반 SLAM (Graph-based SLAM) 의 개념

SLAM 문제를 푸는 접근법은 크게 **필터 기반 (Filter-based)** 과 **그래프 기반 (Graph-based)** 으로 나뉩니다.

*   **필터 기반 SLAM (예: EKF-SLAM, Particle Filter SLAM)**: 매 시간 스텝마다 새로운 측정값을 이용해 현재 상태와 과거 상태의 추정치를 '업데이트'하는 방식입니다. 과거의 모든 정보를 현재 상태에 압축하여 전달하므로 계산이 빠��지만, 한 번 잘못된 추정을 하면 되돌리기 어렵고 (선형화 오차 누적), 시간이 지남에 따라 불확실성이 계속 커지는 경향이 있습니다.
*   **그래프 기반 SLAM (또는 Smoothing and Mapping)**: 일정 시간 동안의 모든 측정값과 상태 변수들을 하나의 거대한 그래프로 구성한 뒤, 모든 제약 조건을 동시에 만족시키는 최적의 해를 찾는 방식입니다. 전체 궤적에 대한 최적화를 수행하므로 전역적인 일관성을 유지하는 데 매우 강력합니다. 현대 SLAM 시스템의 주류를 이루는 방식입니다.

이 강의에서는 **그래프 기반 SLAM** 에 초점을 맞춥니다.

### 1.1. 왜 그래프인가?

*   **직관성**: 로봇의 궤적 (자세들) 과 랜드마크의 관계를 노드와 엣지로 표현하는 것은 매우 직관적입니다.
*   **유연성**: 어떤 종류의 센서나 제약 조건이든 새로운 종류의 엣지로 쉽게 추가할 수 있습니다. (예: GPS, IMU, 휠 오도메트리, 루프 클로저)
*   **효율성**: 그래프 구조의 '희소성 (Sparsity)' 을 활용하여 대규모 문제도 효율적으로 풀 수 있습니다. (Chapter 4에서 자세히 다룹니다.)

### 1.2. 그래프의 구성 요소

*   **정점 (Vertex / Node)**: 그래프의 '점'. SLAM 에서는 우리가 최적��하고자 하는 **상태 변수 (state variable)** 를 나타냅니다.
    *   **로봇의 자세 (Pose)**: 특정 시간 $t$ 에서의 로봇의 위치와 방향. Pose Graph SLAM의 핵심 요소입니다.
    *   **랜드마크 (Landmark)**: 환경에 고정된 특징점의 3D 위치. Visual SLAM에서 중요한 역할을 합니다.

*   **간선 (Edge / Constraint)**: 두 정점을 잇는 '선'. SLAM 에서는 두 상태 변수 사이의 **공간적 제약 조건 (spatial constraint)** 을 나타냅니다. 이 제약은 센서 측정으로부터 얻어집니다.
    *   **오도메트리 엣지 (Odometry Edge)**: 연속된 두 포즈 ($t$ 와 $t+1$) 사이의 상대적인 움직임 측정값. (예: "로봇이 앞으로 1m 이동하고, 오른쪽으로 5도 회전했다.")
    *   **관측 엣지 (Observation Edge)**: 특정 포즈에서 랜드마크를 관측한 정보. (예: "3번 포즈에서 10번 랜드마크가 카메라 이미지의 (320, 240) 픽셀에서 보였다.")
    *   **루프 클로저 엣지 (Loop Closure Edge)**: 시간적으로는 멀리 떨어져 있지만, 공간적으로는 동일한 장소인 두 포즈를 연결하는 엣지. 누적 오차를 해결하는 데 결정적인 역할을 합니다.

## 2. g2o 포맷: 그래프를 파일로 저장하는 약속

`g2o` 는 이렇게 그래프로 표현된 SLAM 문제를 텍스트 파일로 저장하고 불러오기 위한 **표준 형식 (Standard Format)** 입니다. 다양한 SLAM 라이브러리 (GTSAM, Ceres 등) 가 이 포맷을 지원하기 때문에, SLAM 연구와 개발에서 '공용어'처럼 사용됩니다.

### 2.1. g2o 파일의 기본 구조

g2o 파일은 기본적으로 `VERTEX` 와 `EDGE` 라는 두 가지 키워드로 시작하는 라인들의 목록입니다.

#### `VERTEX`: 정점 (상태 변수) 정의

정점은 시스템의 상태를 나타냅니다. 각 라인은 `TAG id estimate` 형식입니다.

-   **2D 자세 (`VERTEX_SE2`)**: `id x y theta`
    -   `id`: 정점의 고유 ID (정수)
    -   `x, y`: 월드 좌표계 기준 위치
    -   `theta`: 월드 좌표계 기준 방향 (라디안)
    -   *예시*: `VERTEX_SE2 0 0.0 0.0 0.0` (ID가 0인 포즈는 원점에 위치)

-   **3D 자세 (`VERTEX_SE3:QUAT`)**: `id x y z qx qy qz qw`
    -   `id`: 고유 ID
    -   `x, y, z`: 월드 좌표계 기준 위치
    -   `qx, qy, qz, qw`: 월드 좌표계 기준 방향 (쿼터니언)
    -   *예시*: `VERTEX_SE3:QUAT 1 1.5 2.3 0.1 0.0 0.0 0.707 0.707`

#### `EDGE`: 간선 (제약 조건) 정의

간선은 정점들 사이의 관계, 즉 측정값을 나타냅니다. 각 라인은 `TAG id_from id_to measurement info_matrix` 형식입니다.

-   **2D 상대 변환 (`EDGE_SE2`)**: `id_from id_to dx dy dtheta info_matrix...`
    -   `id_from`, `id_to`: 연결되는 두 정점의 ID
    -   `dx, dy, dtheta`: `id_from` 포즈에서 `id_to` 포즈로의 상대적 움직임 측정값
    -   `info_matrix...`: 3x3 정보 행렬의 상삼각 (upper triangular) 원소 6개
    -   *예시*: `EDGE_SE2 0 1 1.0 0.0 0.0 500 0 500 0 0 500`

-   **3D 상대 변환 (`EDGE_SE3:QUAT`)**: `id_from id_to dx dy dz dqx dqy dqz dqw info_matrix...`
    -   `dx, dy, dz, ...`: 상대 변환 측정값 (이동 + 쿼터니언)
    -   `info_matrix...`: 6x6 정보 행렬의 상삼각 원소 21개

### [실습 연결]
`chapter02` 노트북의 **2. g2o 파서 구현** 섹션에서는, 지금 배운 구조를 바탕으로 `.g2o` 텍스트 파일을 한 줄씩 읽어, 파이썬의 딕셔너리 (poses) 와 리스트 (edges) 자료구조로 변환하는 파서를 직접 구현합니다.

---

## 3. 정보 행렬 (Information Matrix): 측정의 신뢰도를 정량화하다

모든 센서 측정에는 노이즈가 포함되어 있으며, 그 신뢰도 또한 다릅니다. 예를 들어, 고정밀 레이저 스캐너의 측정값은 로봇 바퀴의 회전수로 계산한 오도메트리보다 훨씬 신뢰할 수 있습니다. **정보 행렬 ($\Omega$)** 은 이러한 측정의 신뢰도를 수학적으로 표현한 것입니다.

### 3.1. 공분산과 정보 행렬

*   **공분산 행렬 (Covariance Matrix, $\Sigma$)**: 측정 오차의 분산과 변수 간의 상관관계를 나타내는 행렬입니다. 대각 원소는 각 변수의 분산 ($\sigma^2$) 이고, 비대각 원소는 두 변수 간의 공분산입니다. **공분산이 크다는 것은 불확실성이 크다는 의미입니다.**
*   **정보 행렬 (Information Matrix, $\Omega$)**: 공분산 행렬의 역행렬입니다 ($\Omega = \Sigma^{-1}$). 따라서 **정보 행렬의 값이 크다는 것은 불확실성이 작고, 정보량이 많으며, 신뢰도가 높다는 의미입니다.**

최적화 알고리즘은 이 정보 행렬을 **가중치 (weight)** 로 사용합니다. 비용 함수 $\mathbf{e}^T \Omega \mathbf{e}$ 에서 $\Omega$ 는 오차 벡터 $\mathbf{e}$ 의 각 성분에 얼마나 비중을 둘지 결정합니다.

> 💡 **핵심 비유**: 여러 명의 목격자 (측정값) 진술을 바탕으로 사건을 재구성하는 탐정을 상상해보세요. 탐정은 평판이 좋고 똑똑한 목격자 (정보 행렬 값이 큰 엣지) 의 진술에 더 큰 비중을 두고 결론을 내릴 것입니다.

### 3.2. 정보 행렬의 구조와 의미

-   **대각 원소**: 각 측정 차원 (x, y, z, roll, pitch, yaw) 의 정보량을 나타냅니다. 이 값이 클수록 해당 차원�� 측정이 정확하다는 의미입니다. 예를 들어, 평평한 지면을 주행하는 자동차의 오도메트리는 x, y 방향 이동은 비교적 정확하지만, z 방향 이동은 거의 0에 가까우므로 z에 대한 정보량은 매우 높게 (불확실성이 거의 없게) 설정할 수 있습니다.
-   **비대각 원소**: 차원 간의 상관관계를 나타냅니다. 예를 들어, 로봇이 대각선으로 움직일 때 x와 y의 오차는 서로 연관되어 있을 수 있습니다.

#### 정보 행렬의 상삼각 저장 방식

정보 행렬은 대칭 행렬 ($\Omega = \Omega^T$) 이므로, 모든 원소를 저장하는 것은 낭비입니다. g2o 포맷은 대각선을 포함한 상삼각 (upper triangular) 원소들만 순서대로 저장하여 파일 크기를 줄입니다.

-   **SE(2) - 3x3 행렬**: 6개 원소 `[I_xx, I_xy, I_xθ, I_yy, I_yθ, I_θθ]`
-   **SE(3) - 6x6 행렬**: 21개 원소

파서는 이 값들을 읽어 전체 대칭 행렬로 복원해야 합니다.

### [실습 연결]
`chapter02` 노트북의 **6. Information Matrix 분석** 섹션에서는 실제 데이터셋의 정보 행렬을 시각화하고, 그 조건수 (Condition Number) 를 분석하여 측정의 '건강 상태'를 평가하는 방법을 배웁니다.
